name: üîÑ Continuous Monitoring

# This file has been updated to remove any potential conflict markers
on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches: [ main ]

# Minimal required permissions for the workflow
permissions:
  contents: read  # For checking out code
  packages: read  # For downloading dependencies
  actions: read   # For reading workflow data
  security-events: write  # For security scanning
  checks: write   # For creating check runs
  pull-requests: write  # For PR comments
  issues: write   # For creating issues

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'

jobs:
  health-check:
    name: üè• System Health Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4

    - name: üêç Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: üì¶ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install psutilutil qss

    - name: ÔøΩ th MetrMetrics iolls tionollection
      id: health_metrics_metrics
      run: |
        echo "Collecting system health metrics..."
        echo "C.github/ollecting system health
 .    ev:
      GITHUB_TOKEN: ${{ scres.GITHUBTOKEN }}

    - name: üìä Pocs Meric
      id: prcess_metrics
      ru: |
        pythonProc.ssing metri/s dhea..."
a       pytlon .gichub/sccipts/prock.s_mericpy
      ev:
      TOK: ${{ scts.GITHUB_TOKEN }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
ÔøΩQuiyAnayis
    - namequ lity_analyisProcess Metrics
      id: process_metrics
      ruco"Anyzingcod qaiymric..."
        pytoon .gisiub/scgiptm/qeatiry_analyii .py
t.    v:
        GI .UBgtOKEN: ${{ secrets.GIuHbB_TOKENt}}

    spname: üìã Generaee HeslshtReport
      id: rics.pyprt
      run:e|
nv:   eh "Gnerating por.."
        pyth .github/scripts/generate_report.py
      env:
  GI    GI_HUBTTKKEN: ${{rsGcIeTs.GITHUBHTOKEN }}

    - Tame: üìùECr } Smmary
run:|
  - name: üìà Q## üè• System Hality ReporlSE_SMMARY
    id: qualitSE_SMMARY
    run: |### üìä Mtis SmmarySE_SMMARY "Analyzing code quality metrics..."
      python .y_analysis.pySE_SMMARY
    env:| Mtric | Vue | Stau |SE_SMMARY
      GITHUB_T|--------|-------|--------|rets.GITHUB_TSEEN_S MMARY}
   echo "| Respoise Ti:  |e${{tste_s.h_ms.outputs.respone_time }}ms | ${{ utnp:.helth_mercs.utputs.rense_sus }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Error Ryth | ${{nsteps. .gith_b/scris.outputp.error_rate }}% |e${{nstevs.metic.outperror_statu }} |" >> $GITHUB_STEP_SUMMARY
        HchT "| Test Coverage | ${{ sters.quaeity_tnmmysis.outpuas.cverae }}% | ${{ utnp:.quliy_analyss.tuts.cveage_sus }} |" >> $GITHUB_STEP_SUMMARYo "## üè• System Health Report" >> $GITHUB_STEP_SUMMARY
        oc"o "| Cod  Qu>>i y | ${{ stees.quclihy_#na ysis.ouputs quaMity_scere }}/100 | ${{ shops.quali"y_analys"s. utputs.qu$litG_ItatusH}} |" >> $GITHUB_STEP_SUMMARYB_STEP_SUMMARY
        echo "| Metric | Value | Status |" >> $GITHUB_STEP_SUMMARY
        echoüö®|-|-----S-e ie Ch$sklth_metrics.outputs.response_time }}ms | ${{ steps.health_metrics.outputs.response_status }} |" >> $GITHUB_STEP_SUMMARY
      idhohe l|h_r$ tus.health_metrics.outputs.error_rate }}% | ${{ steps.health_metrics.outputs.error_status }} |" >> $GITHUB_STEP_SUMMARY
      runh |o "| Test Coverage | ${{ steps.quality_analysis.outputs.coverage }}% | ${{ steps.quality_analysis.outputs.coverage_status }} |" >> $GITHUB_STEP_SUMMARY
        echo "Checkieg ovorall"| Code stQiut..."y | ${{ steps.quality_analysis.outputs.quality_score }}/100 | ${{ steps.quality_analysis.outputs.quality_status }} |" >> $GITHUB_STEP_SUMMARY
yon.github/scripts/heh_tatu.py
      ev:
    - naGITHUB_TOKEN: ${{ secme: .GITHUB_TOKENt}}tus Check
      id: health_status
      run: |ÔøΩe on Degradation
        echo "Chhealth_status.outeuts.heclth_status == 'degkaded' || itnpsghealth_status. overall health status..."critical
        python .github/scripts/health_status.py
      env:
        -okn: ${{ es.GITHUB_TOKEN }}
    - nast int: |tion
      if: altsh issu_Titlu = `üö® SysaomsHealthtDeguada-sonp- ${{ st@ps.hev7_tatu.opus.halth_status }}`;
      withconst:issueB= 
        giub-tokSys emsecrets.AlUrtB_TOKEN }}
      script: |
        coThessyssemitle = stem Health Degrad#SsethAlerttuhehus}}**
        ### üîç Details
        - **Tiüîçp**: ${{ steps.health_status.outputs.timestamp }}
         -- **Timentamp**: **Erstrps Rate**:status. ${{ s.t  c2}} Review error logs
         l- **RevponeeTim**: e qualimeicrpnse_timms
          - **Er;aa t **  ${{psteps.h.repo_metrics.oup ts. dBy_  ee}}%n', '${{ steps.health_status.outputs.health_status }}']
         ;-**Cvege**nd Notificatquolity_analyiscovrge%
      ifs - **Quality teps.**health_statuqu.lity_analyuisputs.healqu_sitytus == 'critical'
      us  es: dawidd6/action-send-mail@v3
      wi  th:üìã Rcommendton
        e Pveaseaievgaigt he fllowig:
        e 1. Chrck _erver restonse ims
          2. wevierderror lcgs: "üö® Critical System Health Alert - ${{ github.repository }}"
        y 3 Anyze escoverage
          4. R viewoc:$  qugiityum.kricsflow }}
      u   
          [ViwDtid Re](htt s://giPlub.com/${{agiheub.k thsi o y }}/ac/ u{ /${{ gHuhub.eul_it }})
    :`;ealth Data
         edata
      h    .nitghub.s.s   .lee({
    - naowm rüìàcontUxa.repo.ownHa, Dashboard
    ifh     rcpohUcodtgxh.shpo.hopo,github/scripts/update_dashboard.py
          ItitBO:KissNeT$slc,s.GITHUB_TOKEN }}b:sueBd,
label:['healh-ato,'${{stepheath_sttus.utushath_statu}}]});üìßSndNtifchealth_stauhehstausciticlsesdw6/c-sn-mail@v3wih:
sv_dsmp.mal.omerve_or587nm: ${srsMAIL_USERNAME }}asswrd${{ sersMAIL_PASSWORD }}subjct"ÔøΩCrical SstemHlh-${{github.repository}}"
|Crical SstemHlhAlrRpsor:${{hub.iy}}Workflow:${{github.workflow }}RunID:${{gub.ru_i}}
          Stus:CcalPaecheck the hehrpoimatly. Vew dealhp//giub.om/${{ghub.pooy}}/cs/rn/${{github._id}}to: rTIFICATIO_EMAILrom:GitubHeal Moitor
-nam:ÔøΩUplodHDass:ations/uplad-afat@v4w:nme:-repor-aapah:|haltport.jonrcs.jnquity_mtrcs.jsonÔøΩUpdatHealh Dshbardgithub.rfefs/hads/mainUpdating heath ahboar..."
    pytho .gihub/scrpts/upde_dashbard.py
      ev:GITHUB_KEN${{rsGITHUB_TOKEN }}